name: Deploy on TXY
on: [push, repository_dispatch]

env:
  MY_SERVER_PRIVATE_KEY: ${{ secrets.MY_V2_SERVER_PRIVATE_KEY }} # 服务器私钥
  MY_USER: ${{ secrets.MY_USER }}
  MY_HOST: ${{ secrets.MY_HOST }}
  MY_DEPLOY_DIR: ${{ secrets.MY_DEPLOY_DIR }}

jobs:
  build-production:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: "actions/checkout@master"
        with:
          submodules: true
      - name: update submodule
        uses: srt32/git-actions@v0.0.3
        with:
          args: "git submodule update --remote"
      - name: commit and push
        uses: github-actions-x/commit@v2.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-branch: 'master'
          commit-message: 'publish'
          force-add: 'true'
      - name: Build Gatsby Site
        uses: jzweifel/gatsby-cli-github-action@master
        with:
          gatsby-arg: build
      - name: Upload result
        uses: actions/upload-artifact@v1
        with:
          name: public
          path: public
          
          
  deploy:
    name: Deploy
    needs: build-production
    runs-on: ubuntu-latest
    steps:
    - name: Download result
      uses: actions/download-artifact@v1
      with:
        name: public

    - name: rsync deployments
      uses: contention/rsync-deployments@v1.0.0
      env:
        DEPLOY_KEY: ${{ secrets.MY_SERVER_PRIVATE_KEY }}
      with:
        args: "-r -e 'ssh -p 54321' --quiet --delete-after ${{ env.MY_USER }}@${{ env.MY_HOST }}:${{ env.MY_DEPLOY_DIR }}"
